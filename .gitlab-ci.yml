stages:
- build
- docker
- deploy

# Az Angular build
build:
  stage: build
  image: node:18
  script:
  - npm install -g @angular/cli
  - npm ci
  - ng build --configuration production
  artifacts:
    paths:
    - dist/

# Docker image építése és deploy
dockerize:
  stage: docker
  image: docker:24.0.7
  services:
  - name: docker:24.0.7-dind
    command: [ "--insecure-registry=192.168.1.37:8083" ]
    alias: docker
  variables:
    DOCKER_HOST: tcp://docker:2375
    DOCKER_TLS_CERTDIR: ""
  script:
  # Bejelentkezés a Nexus Docker registry-be
  - echo "$NEXUS_PASSWORD" | docker login -u "$NEXUS_USERNAME" --password-stdin http://192.168.1.37:8083/repository/docker-hosted/

  # Docker image építése
  - docker build -t 192.168.1.37:8083/repository/docker-hosted/my-angular-app-nginx .

  # Docker képek listázása (ellenőrzés)
  - docker images

  # Docker kép pusholása a Nexus-ra
  - docker push 192.168.1.37:8083/repository/docker-hosted/my-angular-app-nginx
  artifacts:
    paths:
    - dist/

deploy-to-server:
  stage: deploy
  image: alpine:latest
  before_script:
  - apk add --no-cache openssh
  script:
  - echo "$SSH_PRIVATE_KEY" > id_rsa
  - chmod 600 id_rsa
  - |
    ssh -o StrictHostKeyChecking=no -i id_rsa $DEPLOY_USER@$DEPLOY_HOST
      docker login -u $NEXUS_USERNAME -p $NEXUS_PASSWORD http://192.168.1.37:8083 &&
      docker pull 192.168.1.37:8083/repository/docker-hosted/my-angular-app-nginx &&
      docker stop my-app || true &&
      docker rm my-app || true &&
      docker run -d --name my-app -p 80:80 192.168.1.37:8083/repository/docker-hosted/my-angular-app-nginx
    "
